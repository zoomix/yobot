#encoding:utf-8
require 'spec_helper'

describe Yobot::Behaviors::Vasttrafik do

  it "has a description" do
    Yobot::Behaviors::Vasttrafik.new.describe.length > 0
  end
  
  it "parses traffic from masthugget" do
    departure = Yobot::Behaviors::Vasttrafik.new.departures(masthugget_xml, 'masthugg.')[0]
    departure.should == "masthugg. 3 - Marklandsgatan 9min/21min"
  end
  
  it "parses traffic from masthugget2" do
    departure = Yobot::Behaviors::Vasttrafik.new.departures(masthugget2_xml.gsub!(/&lt;/, '<').gsub!(/&gt;/, '>'), 'masthugg.')[0]
    departure.should == "masthugg. 3 - Högsbotorp 4min/24min"
  end
  
  it "parses weird traffic from hagakyrkan" do
    departure = Yobot::Behaviors::Vasttrafik.new.departures(hagakyrkan_xml, 'hagak.')[0]
    departure.should == "hagak. Hållplatsen är indragen för linjerna 753, 760, 764, 765 och 794. Detta på grund av ett arbete från den 9 juni till den 23 juni. (no departure times)"
  end
  
  it "writes stuff to the prompt" do
    room = stub(:room)
    
    room.should_receive(:text).any_number_of_times
    
    Yobot::Behaviors::Vasttrafik.new.react(room, 'departures')
  end
  
  #Västtrafik bot - masthuggstorget - http://vasttrafik.se/External_Services/NextTrip.asmx/GetForecast?identifier=d5542e00-3230-46eb-a73e-5bd6821bf5ef&stopId=00004780
  #Västtrafik bot - hagakyrkan - http://vasttrafik.se/External_Services/NextTrip.asmx/GetForecast?identifier=d5542e00-3230-46eb-a73e-5bd6821bf5ef&stopId=00003040
  #Västtrafik bot - vasaplatsen - http://vasttrafik.se/External_Services/NextTrip.asmx/GetForecast?identifier=d5542e00-3230-46eb-a73e-5bd6821bf5ef&stopId=00007300
  
  def masthugget_xml
    <<-XML
    <?xml version="1.0" encoding="utf-8"?>
    <string xmlns="http://vasttrafik.se/"><?xml version="1.0" encoding="utf-8" standalone="yes"?><root><forecast><items><item line_id="3" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="3" line_number_foreground_color="#FFFFFF" line_number_background_color="#004B85" next_trip="9" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="21" next_next_trip_image="" next_next_trip_alternate_text="" next_next_trip_image_code="" next_quality="1" next_next_quality="0" next_trip_planned_time="2011-06-23T10:59:00" next_next_trip_planned_time="2011-06-23T11:14:00" next_trip_forecast_time="2011-06-23T11:02:13" next_next_trip_forecast_time="0001-01-01T00:00:00" next_creation_time="2011-06-23T10:53:11.5539579" next_next_creation_time="2011-06-23T10:53:11.5539579" trip_id="110764" via="" traffic_island="B"><destination><![CDATA[Marklandsgatan]]></destination></item><item line_id="9" line_image="" line_image_alternate_text="" vehicle_type_id="-1" vehicle_type_code="Unknown" line_number="9" line_number_foreground_color="#000000" line_number_background_color="#6EC8DC" next_trip="9" next_trip_image="http://vasttrafik.se/" next_trip_alternate_text="" next_trip_image_code="" next_next_trip="24" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="0" next_next_quality="1" next_trip_planned_time="2011-06-23T11:02:00" next_next_trip_planned_time="2011-06-23T11:17:00" next_trip_forecast_time="0001-01-01T00:00:00" next_next_trip_forecast_time="2011-06-23T11:17:26" next_creation_time="2011-06-23T10:53:11.5539579" next_next_creation_time="2011-06-23T10:53:11.5539579" trip_id="111097" via="" traffic_island="B"><destination><![CDATA[Saltholmen]]></destination></item><item line_id="11" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="11" line_number_foreground_color="#FFFFFF" line_number_background_color="#000000" next_trip="3" next_trip_image="http://vasttrafik.se/" next_trip_alternate_text="" next_trip_image_code="" next_next_trip="17" next_next_trip_image="" next_next_trip_alternate_text="" next_next_trip_image_code="" next_quality="1" next_next_quality="0" next_trip_planned_time="2011-06-23T10:55:00" next_next_trip_planned_time="2011-06-23T11:10:00" next_trip_forecast_time="2011-06-23T10:56:31" next_next_trip_forecast_time="0001-01-01T00:00:00" next_creation_time="2011-06-23T10:53:11.5539579" next_next_creation_time="2011-06-23T10:53:11.5539579" trip_id="127249" via="" traffic_island="B"><destination><![CDATA[Saltholmen]]></destination></item></items></forecast><free_text><items /></free_text></root></string>
    XML
  end
  
  def masthugget2_xml
    <<-XML
    <?xml version="1.0" encoding="utf-8"?>
    <string xmlns="http://vasttrafik.se/">&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;&lt;root&gt;&lt;forecast&gt;&lt;items&gt;&lt;item line_id="3" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="3" line_number_foreground_color="#FFFFFF" line_number_background_color="#004B85" next_trip="4" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="24" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="1" next_next_quality="1" next_trip_planned_time="2011-06-24T09:30:00" next_next_trip_planned_time="2011-06-24T09:52:00" next_trip_forecast_time="2011-06-24T09:34:38" next_next_trip_forecast_time="2011-06-24T09:53:48" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="87867" via="" traffic_island="B"&gt;&lt;destination&gt;&lt;![CDATA[Högsbotorp]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="3" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="3" line_number_foreground_color="#FFFFFF" line_number_background_color="#004B85" next_trip="43" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="" next_next_trip_image="" next_next_trip_alternate_text="" next_next_trip_image_code="" next_quality="1" next_next_quality="0" next_trip_planned_time="2011-06-24T10:13:00" next_next_trip_planned_time="0001-01-01T00:00:00" next_trip_forecast_time="2011-06-24T10:13:00" next_next_trip_forecast_time="0001-01-01T00:00:00" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="86368" via="" traffic_island="B"&gt;&lt;destination&gt;&lt;![CDATA[Marklandsgatan]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="9" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="9" line_number_foreground_color="#000000" line_number_background_color="#6EC8DC" next_trip="14" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="32" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="1" next_next_quality="1" next_trip_planned_time="2011-06-24T09:42:00" next_next_trip_planned_time="2011-06-24T10:02:00" next_trip_forecast_time="2011-06-24T09:43:47" next_next_trip_forecast_time="2011-06-24T10:02:00" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="86937" via="" traffic_island="B"&gt;&lt;destination&gt;&lt;![CDATA[Saltholmen]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="11" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="11" line_number_foreground_color="#FFFFFF" line_number_background_color="#000000" next_trip="6" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="26" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="1" next_next_quality="1" next_trip_planned_time="2011-06-24T09:35:00" next_next_trip_planned_time="2011-06-24T09:57:00" next_trip_forecast_time="2011-06-24T09:36:06" next_next_trip_forecast_time="2011-06-24T09:56:08" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="87126" via="" traffic_island="B"&gt;&lt;destination&gt;&lt;![CDATA[Saltholmen]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="3" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="3" line_number_foreground_color="#FFFFFF" line_number_background_color="#004B85" next_trip="3" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="21" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="1" next_next_quality="1" next_trip_planned_time="2011-06-24T09:31:00" next_next_trip_planned_time="2011-06-24T09:51:00" next_trip_forecast_time="2011-06-24T09:33:33" next_next_trip_forecast_time="2011-06-24T09:51:26" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="87369" via="" traffic_island="A"&gt;&lt;destination&gt;&lt;![CDATA[Kålltorp]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="9" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="9" line_number_foreground_color="#000000" line_number_background_color="#6EC8DC" next_trip="7" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="27" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="1" next_next_quality="1" next_trip_planned_time="2011-06-24T09:37:00" next_next_trip_planned_time="2011-06-24T09:57:00" next_trip_forecast_time="2011-06-24T09:37:11" next_next_trip_forecast_time="2011-06-24T09:57:00" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="86882" via="" traffic_island="A"&gt;&lt;destination&gt;&lt;![CDATA[Angered]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="10" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="10" line_number_foreground_color="#000000" line_number_background_color="#B4E16E" next_trip="5" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="" next_next_trip_image="" next_next_trip_alternate_text="" next_next_trip_image_code="" next_quality="1" next_next_quality="0" next_trip_planned_time="2011-06-24T09:36:00" next_next_trip_planned_time="0001-01-01T00:00:00" next_trip_forecast_time="2011-06-24T09:35:25" next_next_trip_forecast_time="0001-01-01T00:00:00" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="87033" via="Kapellplatsen" traffic_island="A"&gt;&lt;destination&gt;&lt;![CDATA[Guldheden]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;item line_id="11" line_image="http://vasttrafik.se/CustomerTemplates/Public/Images/sparvagn.gif" line_image_alternate_text="Spårvagn" vehicle_type_id="2" vehicle_type_code="Tram" line_number="11" line_number_foreground_color="#FFFFFF" line_number_background_color="#000000" next_trip="11" next_trip_image="http://vasttrafik.se/CustomerTemplates/Public/Images/hcp12.jpg" next_trip_alternate_text="Handikappanpassad" next_trip_image_code="R" next_next_trip="32" next_next_trip_image="/CustomerTemplates/Public/Images/hcp12.jpg" next_next_trip_alternate_text="Handikappanpassad" next_next_trip_image_code="R" next_quality="1" next_next_quality="1" next_trip_planned_time="2011-06-24T09:41:00" next_next_trip_planned_time="2011-06-24T10:02:00" next_trip_forecast_time="2011-06-24T09:41:24" next_next_trip_forecast_time="2011-06-24T10:02:00" next_creation_time="2011-06-24T09:30:12.4168823" next_next_creation_time="2011-06-24T09:30:12.4168823" trip_id="87079" via="" traffic_island="A"&gt;&lt;destination&gt;&lt;![CDATA[Bergsjön]]&gt;&lt;/destination&gt;&lt;/item&gt;&lt;/items&gt;&lt;/forecast&gt;&lt;free_text&gt;&lt;items /&gt;&lt;/free_text&gt;&lt;/root&gt;</string>
    XML
  end
  
  def hagakyrkan_xml
    <<-XML
    <?xml version="1.0" encoding="utf-8"?>
    <string xmlns="http://vasttrafik.se/"><?xml version="1.0" encoding="utf-8" standalone="yes"?><root><forecast><items /></forecast><free_text><items><item><text><![CDATA[Hållplatsen är indragen för linjerna 753, 760, 764, 765 och 794. Detta på grund av ett arbete från den 9 juni till den 23 juni.]]></text></item><item><text><![CDATA[Mellan  19 - 23 juni är det ingen spårvagnstrafik mellan Järntorget och Hagakyrkan. Det berör linje 1, 3, 6, 9 och 11 i bägge riktningar och beror på ett spårarbete. ]]></text></item><item><text><![CDATA[Linjerna 753, 760, 764 och 765 avgår från reservhållplats Parkgatan. Detta på grund av ett arbete från den 9 juni till den 23 juni.]]></text></item></items></free_text></root></string>
    XML
  end
  
end
